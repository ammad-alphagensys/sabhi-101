name: Secrets Scan

on:
  pull_request:
  push:
    branches: [main, staging]

permissions:
  contents: read
  pull-requests: write

jobs:
  base:
    uses: ./.github/workflows/_base.yml
  gitleaks:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync env templates
        run: |
          bun run scripts/sync-env-templates.ts
          git diff --exit-code .env || (
            echo "âŒ Env templates out of sync. Run env sync locally." && exit 1
          )

      - name: Run Gitleaks
        id: gitleaks
        uses: gitleaks/gitleaks-action@v2
        with:
          config: .gitleaks.toml
          args: >
            detect
            --redact
            --report-format json
            --report-path gitleaks.json
        continue-on-error: true

      - name: Fail on severity >= high
        run: |
          jq -e '
            [.findings[] | select(.Severity=="high" or .Severity=="critical")] | length == 0
          ' gitleaks.json

      - name: Comment on PR if secrets found
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            if (!fs.existsSync('gitleaks-report.json')) return;

            const findings = JSON.parse(fs.readFileSync('gitleaks-report.json'));
            const highRisk = findings.filter(f =>
              f.Severity === 'critical' || f.Severity === 'high'
            );

            if (highRisk.length === 0) return;

            let body = `ğŸš¨ **Secret Scan Failed**\n\n`;
            body += `The following **high/critical secrets** were detected:\n\n`;

            highRisk.forEach(f => {
              body += `- **${f.Description}**\n`;
              body += `  - File: \`${f.File}\`\n`;
              body += `  - Rule: \`${f.RuleID}\`\n\n`;
            });

            body += `ğŸ” Please rotate affected credentials and remove them from the PR.\n`;
            body += `ğŸ“„ Use \`.env.template\` for placeholders.\n`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
